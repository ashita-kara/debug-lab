<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é…é”ãƒ¡ãƒ¢ v2.2</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f0f4f8; color: #333; margin: 0; }
        .header { background: #007bff; color: white; padding: 15px; text-align: center; font-weight: bold; margin-bottom: 15px; }
        .btn { width: 100%; height: 70px; border-radius: 35px; font-size: 22px; font-weight: bold; margin-bottom: 15px; border: none; box-shadow: 0 4px 12px rgba(0,123,255,0.3); }
        .btn-start { background: #007bff; color: white; }
        .btn-stop { background: #dc3545; color: white; display: none; }
        #status { background: #fff; padding: 15px; border-radius: 12px; min-height: 45px; margin-bottom: 15px; border: 1px solid #d1d9e6; font-size: 1.1em; }
        .card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .res-line { margin-top: 8px; font-size: 1.1em; }
        .res-val { color: #d9534f; font-weight: bold; font-size: 1.2em; border-bottom: 2px solid #f8d7da; }
        .original-txt { color: #888; font-size: 0.85em; margin-bottom: 5px; border-left: 3px solid #ddd; padding-left: 8px; }
    </style>
</head>
<body>
    <div class="header">é…é”åŠ¹ç‡è¨ˆç®—ãƒœã‚¤ã‚¹ãƒ¡ãƒ¢</div>
    <div style="padding: 10px;">
        <button id="start-btn" class="btn btn-start">ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
        <button id="stop-btn" class="btn btn-stop">â¹ å®Œäº† / è¨ˆç®—</button>
        <div id="status">å¾…æ©Ÿä¸­...</div>
        <div id="history"></div>
    </div>

<script>
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const statusDiv = document.getElementById('status');
    const historyDiv = document.getElementById('history');
    let recognition;

    startBtn.onclick = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { alert("ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"); return; }
        
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.interimResults = true;
        recognition.continuous = true;

        recognition.onstart = () => {
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            statusDiv.innerText = "è´ãå–ã‚Šä¸­...";
        };

        recognition.onresult = (event) => {
            let fullText = "";
            for (let i = 0; i < event.results.length; i++) {
                fullText += event.results[i][0].transcript;
            }
            statusDiv.innerText = fullText;
        };

        recognition.onend = () => {
            processText(statusDiv.innerText);
            resetUI();
        };

        recognition.onerror = () => { resetUI(); };
        recognition.start();
    };

    stopBtn.onclick = () => { if (recognition) recognition.stop(); };

    function resetUI() {
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
    }

    function processText(text) {
        if (!text || text === "è´ãå–ã‚Šä¸­..." || text === "å¾…æ©Ÿä¸­...") return;

        // ã€é‡è¤‡å¯¾ç­–ã€‘æœ€åˆã«è¦‹ã¤ã‹ã£ãŸæ•°å€¤ã ã‘ã‚’ä½¿ç”¨
        const amountMatch = text.match(/(\d+)å††/);
        const amount = amountMatch ? amountMatch[1] : null;

        const minMatch = text.match(/(\d+)åˆ†/);
        const mins = minMatch ? minMatch[1] : null;
        
        // ã€æ”¹å–„ã€‘km, ã‚­ãƒ­, kg, ãŒ” å…¨ã¦ã‚’ã€Œè·é›¢(km)ã€ã¨ã—ã¦èªè­˜
        const distMatch = text.match(/(\d+(?:\.\d+)?)(?:km|ã‚­ãƒ­|kg|k|ãŒ”|ãƒ¡ãƒ¼ãƒˆãƒ«)/);
        const dist = distMatch ? distMatch[1] : null;

        let results = [];
        if (amount) {
            // æ™‚é–“å˜ä¾¡
            if (mins) {
                const pMin = (amount / mins).toFixed(1);
                const pHour = Math.round(pMin * 60).toLocaleString();
                results.push(`<div class="res-line">ğŸ’° <span class="res-val">${pMin}å††/åˆ†</span> (${pHour}å††/æ™‚)</div>`);
            }
            // è·é›¢å˜ä¾¡ï¼ˆã‚­ãƒ­ã€kgã©ã¡ã‚‰ã§ã‚‚ã“ã“ã§è¨ˆç®—ï¼‰
            if (dist) {
                const pKm = (amount / dist).toFixed(1);
                results.push(`<div class="res-line">ğŸ“ <span class="res-val">${pKm}å††/km</span></div>`);
            }
        }

        const card = document.createElement('div');
        card.className = 'card';
        // è¡¨ç¤ºã‚’ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹ãŸã‚ã€é‡è¤‡ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã¯ãã®ã¾ã¾è¡¨ç¤ºã—ã¾ã™ãŒ
        // è¨ˆç®—çµæœã¯ä¸Šè¨˜ãƒ­ã‚¸ãƒƒã‚¯ã§ã€Œ1å›åˆ†ã€ã«çµã£ã¦ã„ã¾ã™
        card.innerHTML = `
            <div class="original-txt">${text}</div>
            ${results.length > 0 ? results.join('') : '<div class="res-line">ğŸ“ ãƒ¡ãƒ¢</div>'}
        `;
        historyDiv.prepend(card);
        statusDiv.innerText = "å¾…æ©Ÿä¸­...";
    }
</script>
</body>
</html>
        }

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = resHtml + results.join('');
        historyDiv.prepend(card);
        statusDiv.innerText = "å¾…æ©Ÿä¸­...";
    }
</script>
</body>
</html>
