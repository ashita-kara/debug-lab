<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é…é”ãƒœã‚¤ã‚¹ãƒ¡ãƒ¢ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; color: #333; }
        .btn { width: 100%; height: 65px; border-radius: 35px; font-size: 20px; font-weight: bold; margin-bottom: 15px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: 0.2s; }
        .btn-start { background: #007bff; color: white; }
        .btn-stop { background: #dc3545; color: white; display: none; }
        #status { background: #fff; padding: 15px; border-radius: 12px; min-height: 40px; margin-bottom: 15px; border: 1px solid #ddd; font-size: 1.1em; }
        .card { background: white; padding: 18px; border-radius: 15px; margin-top: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.08); animation: slideIn 0.3s ease-out; }
        .res-line { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
        .res-val { color: #d9534f; font-weight: bold; font-size: 1.2em; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <button id="start-btn" class="btn btn-start">ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
    <button id="stop-btn" class="btn btn-stop">â¹ åœæ­¢ã—ã¦è¨ˆç®—</button>
    <div id="status">å¾…æ©Ÿä¸­...</div>
    <div id="history"></div>

<script>
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const statusDiv = document.getElementById('status');
    const historyDiv = document.getElementById('history');
    let recognition;
    let finalResult = ""; // ç¢ºå®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒ

    startBtn.onclick = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { alert("æœªå¯¾å¿œã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™"); return; }
        
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.interimResults = true; // é€”ä¸­çµŒéã‚’å–å¾—
        recognition.continuous = true;    // é€£ç¶šèªè­˜

        finalResult = ""; // ãƒªã‚»ãƒƒãƒˆ
        
        recognition.onstart = () => {
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            statusDiv.innerText = "è´ãå–ã‚Šä¸­...";
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalResult += transcript; // ç¢ºå®šã—ãŸéƒ¨åˆ†ã ã‘ã‚’ç¹‹ã’ã‚‹
                } else {
                    interimTranscript = transcript; // ã¾ã ç¢ºå®šã—ã¦ã„ãªã„äºˆæ¸¬éƒ¨åˆ†
                }
            }
            // è¡¨ç¤ºã¯ã€Œç¢ºå®šæ¸ˆã¿ï¼‹äºˆæ¸¬ã€ã‚’å‡ºã™ãŒã€é‡è¤‡ã—ãªã„ã‚ˆã†ã«åˆ¶å¾¡
            statusDiv.innerText = finalResult + interimTranscript;
        };

        recognition.onend = () => {
            // æœ€çµ‚çš„ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ã£ã¦è¨ˆç®—
            process(statusDiv.innerText);
            resetUI();
        };

        recognition.onerror = () => { resetUI(); };
        recognition.start();
    };

    stopBtn.onclick = () => { if (recognition) recognition.stop(); };

    function resetUI() {
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
    }

    function process(text) {
        if (!text || text === "è´ãå–ã‚Šä¸­..." || text === "å¾…æ©Ÿä¸­...") return;

        // æ­£è¦è¡¨ç¾ã§æœ€åˆã®æ•°å€¤ã ã‘ã‚’æ‹¾ã†ï¼ˆé‡è¤‡ã—ã¦ã„ã¦ã‚‚æœ€åˆã®1ã¤ã ã‘ã‚’ä½¿ã†ï¼‰
        const amount = text.match(/(\d+)å††/)?.[1];
        const mins = text.match(/(\d+)åˆ†/)?.[1];
        const kms = text.match(/(\d+(?:\.\d+)?)k?m/)?.[1];

        let resHtml = `<div style="color:#666; font-size:0.9em;">${text}</div>`;
        let results = [];

        if (amount) {
            if (mins) {
                const pMin = (amount / mins).toFixed(1);
                const pHour = Math.round(pMin * 60).toLocaleString();
                results.push(`<div class="res-line">ğŸ’° <span class="res-val">${pMin}å††/åˆ†</span> (${pHour}å††/æ™‚)</div>`);
            }
            if (kms) {
                const pKm = (amount / kms).toFixed(1);
                results.push(`<div class="res-line">ğŸ“ <span class="res-val">${pKm}å††/km</span></div>`);
            }
        }

        if (results.length === 0 && !amount && !mins && !kms) {
            results.push(`<div class="res-line">ğŸ“ ãƒ¡ãƒ¢ã¨ã—ã¦ä¿å­˜</div>`);
        }

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = resHtml + results.join('');
        historyDiv.prepend(card);
        statusDiv.innerText = "å¾…æ©Ÿä¸­...";
    }
</script>
</body>
</html>
